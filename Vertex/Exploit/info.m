//
//  info.c
//  Apex
//
//  Created by Alfie on 18/09/2024.
//

#include "info.h"
#include "krw.h"
#include <stdbool.h>

uint64_t get_kernel_slide(void) {
    uint64_t crLabel = kread64(gUcred + 0x78); // ucred->cr_label
    uint64_t entitlements = kread64(crLabel + 0x8);
    uint64_t vtable = kread64(entitlements);
    uint64_t funct = kread64(vtable + (8 * 0x1F));
    uint64_t kernelPage = funct & ~(uint64_t)0xFFF;
    
    while (true) {
        uint32_t header = kread32(kernelPage);
        if (header == 0xFEEDFACF) {
            return kernelPage - (uint64_t)0xFFFFFFF007004000;
        }
        kernelPage -= 0x1000;
    }
}

int info_init(uint64_t task) {
    gTask = task;
    gProc = kread64(task + 0x390); // task->bsd_info
    gUcred = kread64(gProc + 0xF0); // proc->ucred
    return 0;
}

